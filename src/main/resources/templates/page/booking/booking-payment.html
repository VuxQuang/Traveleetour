<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Thanh toán - Travelee</title>
	<link rel="stylesheet" th:href="@{/page/css/booking-confirmation.css}">
    <script th:inline="javascript">
		document.addEventListener('DOMContentLoaded', function () {
			const bookingId = /*[[${booking.id}]]*/ 0;
			const statusUrl = `/page/payment/${bookingId}/status`;
			const pollIntervalMs = 3000;
			let pollCount = 0;
			const maxPollCount = 60; // Tối đa 3 phút (60 * 3 giây)

			// Cập nhật trạng thái hiển thị
			function updatePaymentStatus(paymentStatus, bookingStatus) {
				const statusElement = document.querySelector('.status-badge span');
				const statusBadge = document.querySelector('.status-badge');
				
				if (statusElement && statusBadge) {
					// Chỉ đánh dấu đã thanh toán khi payment thực sự COMPLETED
					if (paymentStatus === 'COMPLETED') {
						statusElement.textContent = 'Đã thanh toán';
						statusBadge.className = 'status-badge confirmed';
					} else {
						statusElement.textContent = 'Chưa thanh toán';
						statusBadge.className = 'status-badge pending';
					}
				}
			}

			// Hiển thị thông tin debug
			function showDebugInfo(data) {
				const debugDiv = document.querySelector('.debug-info');
				if (debugDiv && data) {
					debugDiv.innerHTML = `
						<strong>Real-time Status:</strong><br/>
						Payment Status: ${data.paymentStatus || 'N/A'}<br/>
						Booking Status: ${data.bookingStatus || 'N/A'}<br/>
						Last Check: ${new Date().toLocaleTimeString()}<br/>
						Poll Count: ${pollCount}
					`;
				}
			}

			function pollStatus() {
				if (pollCount >= maxPollCount) {
					console.log('Đã đạt giới hạn polling, dừng kiểm tra');
					return;
				}

				pollCount++;
				console.log(`Kiểm tra trạng thái lần ${pollCount}...`);

				fetch(statusUrl, { credentials: 'same-origin' })
					.then(res => {
						if (!res.ok) {
							throw new Error(`HTTP ${res.status}: ${res.statusText}`);
						}
						return res.json();
					})
					.then(data => {
						console.log('Response data:', data);
						
						if (data && !data.error) {
							// Cập nhật trạng thái hiển thị real-time
							updatePaymentStatus(data.paymentStatus, data.bookingStatus);
							
							// Hiển thị thông tin debug
							showDebugInfo(data);
							
							// Chỉ tự động chuyển trang khi payment đã COMPLETED
							if (data.paymentStatus === 'COMPLETED') {
								console.log('Thanh toán thành công, chuyển hướng...');
								const redirectUrl = data.redirectUrl || `/page/booking/confirmation/${bookingId}`;
								window.location.replace(redirectUrl);
								return;
							}
							
							// Tiếp tục polling
							setTimeout(pollStatus, pollIntervalMs);
						} else {
							console.error('API trả về lỗi:', data.error);
							// Vẫn tiếp tục polling nếu có lỗi
							setTimeout(pollStatus, pollIntervalMs);
						}
					})
					.catch(error => {
						console.error('Lỗi khi kiểm tra trạng thái:', error);
						// Vẫn tiếp tục polling nếu có lỗi network
						setTimeout(pollStatus, pollIntervalMs);
					});
			}

			// Khởi tạo trạng thái ban đầu
			updatePaymentStatus(/*[[${booking.payment != null and booking.payment.status == 'COMPLETED' ? 'COMPLETED' : 'PENDING'}]]*/ 'PENDING', /*[[${booking.status}]]*/ 'PENDING');
			
			// Bắt đầu polling
			pollStatus();
		});
	</script>
</head>
<body>
	<main class="confirmation-container">
		<div class="container">
			<div class="section-title">
				<h2>Thanh toán cho booking <span th:text="${booking.bookingCode}">BK</span></h2>
			</div>

			<div class="details-grid">
				<div class="detail-item">
					<label>Tổng tiền:</label>
					<span class="amount" th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">0 VNĐ</span>
				</div>
				<div class="detail-item">
					<label>Trạng thái thanh toán:</label>
					<span class="status-badge pending">
						<span>Đang kiểm tra...</span>
					</span>
				</div>
				<div class="detail-item">
					<label>Mã booking:</label>
					<span th:text="${booking.bookingCode}">BK</span>
				</div>
				<div class="detail-item">
					<label>Trạng thái booking:</label>
					<span th:text="${booking.status}">PENDING</span>
				</div>
			</div>

			<!-- Thông tin debug (chỉ hiển thị trong development) -->
			<div th:if="${@environment.getActiveProfiles().length > 0 and @environment.getActiveProfiles()[0] == 'dev'}" 
				 class="alert alert-info" style="margin: 16px 0; font-size: 12px;">
				<strong>Debug Info:</strong><br/>
				Payment ID: <span th:text="${booking.payment != null ? booking.payment.id : 'N/A'}">N/A</span><br/>
				Payment Status: <span th:text="${booking.payment != null ? booking.payment.status : 'N/A'}">N/A</span><br/>
				Payment Created: <span th:text="${booking.payment != null ? #temporals.format(booking.payment.createdAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}">N/A</span><br/>
				Payment Paid: <span th:text="${booking.payment != null and booking.payment.paidAt != null ? #temporals.format(booking.payment.paidAt, 'dd/MM/yyyy HH:mm:ss') : 'N/A'}">N/A</span>
			</div>

			<!-- Real-time debug info -->
			<div class="debug-info" style="margin: 16px 0; padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
				<strong>Real-time Status:</strong><br/>
				Đang khởi tạo...
			</div>

			<div th:if="${qrImageUrl != null}" class="tour-card" style="text-align:center; padding: 16px;">
				<img th:src="${qrImageUrl}" alt="VietQR" style="max-width: 320px; width: 100%;"/>
				<p style="margin-top: 8px;">Quét QR để thanh toán số tiền <b th:text="${#numbers.formatDecimal(booking.totalAmount, 0, 'COMMA', 0, 'POINT')}">0</b> VNĐ</p>
				<p>Nội dung chuyển khoản: <b th:text="${booking.bookingCode}">BK</b></p>
				<p>Ngân hàng: <b th:text="${bankCode}">VCB</b> | Số tài khoản: <b th:text="${accountNumber}">0000</b> | Tên: <b th:text="${accountName}">TRAVELEE</b></p>
			</div>

			<div th:if="${qrImageUrl == null}" class="alert" style="background:#fff3cd; padding:12px; border:1px solid #ffeeba;">
				Bạn chưa cấu hình thông tin tài khoản theo dõi của SePay. Vui lòng thêm vào application.properties: <br/>
				<code>sepay.bank-code=VCB</code><br/>
				<code>sepay.account-number=...</code><br/>
				<code>sepay.account-name=...</code>
			</div>

			<div class="action-buttons">
				<a th:href="@{'/page/booking/confirmation/' + ${booking.id}}" class="btn btn-outline-primary">Quay lại xác nhận</a>
				<a th:href="@{/page/booking/history}" class="btn btn-primary">Lịch sử đặt tour</a>
			</div>
		</div>
	</main>
</body>
</html>


