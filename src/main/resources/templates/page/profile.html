<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang cá nhân - TravelGo</title>
    <link rel="stylesheet" th:href="@{/page/css/profile.css}">
    <link rel="stylesheet" th:href="@{/page/css/homepage.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<style>
    .alert-danger {
        color: red;
        font-weight: 500;
        margin-top: 10px;
    }

    .alert-success {
        color: green;
        font-weight: 500;
        margin-top: 10px;
    }
</style>
<body>

<!-- Header với thông tin liên hệ -->
<div th:replace="~{/page/fragments/header :: header}"></div>

<!-- Sidebar -->
<div th:replace="~{/page/fragments/navbar :: navbar}"></div>

<main class="main profile-main">
    <div class="container">
        <div class="profile-wrapper">
            <aside class="profile-sidebar">
                <div class="profile-avatar">
                    <img th:src="@{/page/imgs/4.jpg}" alt="Avatar" class="logo-img" id="userAvatar">
                    <button type="button" id="changeAvatarBtn" class="btn btn-avatar">Đổi ảnh đại diện</button>
                    <h3 class="profile-name" th:text="${loggedInUser.fullName}">Họ tên</h3>
                    <p class="profile-email" th:text="${loggedInUser.email}">Email</p>
                </div>
                <ul class="profile-menu">
                    <li class="profile-menu-item active" data-tab="info"><i class="fas fa-user"></i> Thông tin cá nhân</li>
                    <li class="profile-menu-item" data-tab="tours"><i class="fas fa-suitcase-rolling"></i> Tour đã đặt</li>
                    <li class="profile-menu-item" data-tab="booking-confirmation"><i class="fas fa-check-circle"></i> Xác nhận đặt tour</li>
                    <li class="profile-menu-item" data-tab="password"><i class="fas fa-key"></i> Đổi mật khẩu</li>
                    <li class="profile-menu-item" data-tab="support"><i class="fas fa-headset"></i> Phản hồi hỗ trợ</li>
                </ul>
            </aside>
            <section class="profile-content">
                <div class="profile-tab profile-info active">
                    <h2>Thông tin cá nhân</h2>
                    <form th:action="@{/profile/update}" method="post" th:object="${updateUserDto}">
                        <div class="form-group">
                            <label>Họ và tên</label>
                            <input type="text" th:field="*{fullName}" placeholder="Không thay đổi nếu để trống" />
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" th:field="*{email}" readonly />
                        </div>
                        <div class="form-group">
                            <label>Số điện thoại</label>
                            <input type="text" th:field="*{phoneNumber}" placeholder="Không thay đổi nếu để trống" />
                        </div>
                        <div class="form-group">
                            <label>Địa chỉ</label>
                            <input type="text" th:field="*{address}" placeholder="Không thay đổi nếu để trống" />
                        </div>
                        <button type="submit" class="btn btn-register">Cập nhật</button>
                    </form>
                </div>
                <div class="profile-tab profile-tours">
                    <h2>Tour đã đặt</h2>
                    
                    <!-- Thông báo thành công/lỗi -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                    
                    <div class="tours-table-wrapper">
                        <div th:if="${userBookings == null || userBookings.isEmpty()}" class="no-bookings">
                            <p>Bạn chưa có tour nào được đặt.</p>
                        </div>
                        <table th:if="${userBookings != null && !userBookings.isEmpty()}" class="tours-table">
                            <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên tour</th>
                                <th>Thông tin</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="booking, iterStat : ${userBookings}">
                                <td th:text="${iterStat.count}">1</td>
                                <td>
                                    <div class="tour-title">
                                        <a th:href="@{/page/tours/{id}(id=${booking.tour.id})}" 
                                           class="tour-link">
                                            <i class="fas fa-external-link-alt"></i> <span th:text="${booking.tour.title}">Tên tour</span>
                                        </a>
                                    </div>
                                    <div><b>Loại tour:</b> <span th:text="${booking.tour.categories != null and !booking.tour.categories.isEmpty() ? #strings.listJoin(booking.tour.categories.![name], ', ') : 'Chưa phân loại'}">Loại tour</span></div>
                                    <div><b>Điểm xuất phát:</b> <span th:text="${booking.tour.departure}">Điểm xuất phát</span></div>
                                    <div><b>Điểm đến:</b> <span th:text="${booking.tour.destination}">Điểm đến</span></div>
                                    <div th:if="${booking.schedule != null}">
                                        <div><b>Ngày khởi hành:</b> <span th:text="${#temporals.format(booking.schedule.departureDate, 'dd/MM/yyyy')}">Ngày khởi hành</span></div>
                                        <div><b>Ngày trở về:</b> <span th:text="${#temporals.format(booking.schedule.returnDate, 'dd/MM/yyyy')}">Ngày trở về</span></div>
                                    </div>
                                </td>
                                <td>
                                    <div><b>Mã booking:</b> <span th:text="${booking.bookingCode}">Mã booking</span></div>
                                    <div><b>Số người lớn:</b> <span th:text="${booking.adultCount}">0</span> - <b>Thành tiền:</b> <span th:text="${booking.adultCount * booking.tour.adultPrice}">0</span> vnd</div>
                                    <div><b>Số trẻ em:</b> <span th:text="${booking.childCount}">0</span> - <b>Thành tiền:</b> <span th:text="${booking.childCount * booking.tour.childPrice}">0</span> vnd</div>
                                    <div th:if="${booking.discountAmount != null && booking.discountAmount > 0}">
                                        <b>Giảm giá:</b> <span th:text="${booking.discountAmount}">0</span> vnd
                                    </div>
                                    <div><b>Tổng tiền:</b> <span th:text="${booking.totalAmount}">0</span> vnd</div>
                                    <div th:if="${booking.specialRequests != null && !booking.specialRequests.isEmpty()}">
                                        <b>Ghi chú:</b> <span th:text="${booking.specialRequests}">Ghi chú</span>
                                    </div>
                                    <div><b>Ngày đặt:</b> <span th:text="${booking.createdAt}">Ngày đặt</span></div>
                                </td>
                                <td>
                                    <div class="booking-status">
                                        <span th:class="'status ' + ${booking.status.name().toLowerCase()}" 
                                              th:text="${booking.status.name() == 'PENDING' ? 'Chờ xác nhận' : 
                                                        booking.status.name() == 'CONFIRMED' ? 'Đã xác nhận' :
                                                        booking.status.name() == 'PAID' ? 'Đã thanh toán' :
                                                        booking.status.name() == 'CANCELLED' ? 'Đã hủy' :
                                                        booking.status.name() == 'COMPLETED' ? 'Hoàn thành' :
                                                        booking.status.name() == 'REFUNDED' ? 'Đã hoàn tiền' : 'Không xác định'}">
                                            Trạng thái
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <div class="booking-actions">
                                        <div th:if="${booking.status.name() == 'PENDING' || booking.status.name() == 'CONFIRMED'}" class="action-item">
                                            <form th:action="@{/profile/cancel-booking/{id}(id=${booking.id})}" method="post" style="display: inline;">
                                                <button type="submit" class="btn-cancel" onclick="return confirm('Bạn có chắc chắn muốn hủy tour này không?')">Hủy</button>
                                            </form>
                                        </div>
                                        <div th:if="${booking.status.name() == 'PAID' || booking.status.name() == 'COMPLETED' || booking.status.name() == 'REFUNDED'}" class="action-item">
                                            <span style="color:#6c757d; font-size: 12px;">Không thể hủy sau khi đã thanh toán/hoàn thành/hoàn tiền</span>
                                        </div>
                                        <div class="action-item">
                                            <a th:href="@{/page/booking/confirmation/{bookingId}(bookingId=${booking.id})}" class="btn-detail">Chi tiết đơn đặt tour</a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="profile-tab profile-password">
                    <h2>Đổi mật khẩu</h2>
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <form id="changePasswordForm" method="post" th:action="@{/profile/change-password}">
                        <div class="form-group password-group">
                            <label for="oldPassword">Mật khẩu hiện tại</label>
                            <div class="password-wrapper">
                                <input type="password" id="oldPassword" name="oldPassword" required>
                                <span class="toggle-password" data-target="oldPassword">
                                     <i class="fas fa-eye"></i>
                                 </span>
                            </div>
                        </div>
                        <div class="form-group password-group">
                            <label for="newPassword">Mật khẩu mới</label>
                            <div class="password-wrapper">
                                <input type="password" id="newPassword" name="newPassword" required>
                                <span class="toggle-password" data-target="newPassword">
                                     <i class="fas fa-eye"></i>
                                </span>
                            </div>
                        </div>
                        <div class="form-group password-group">
                            <label for="confirmPassword">Xác nhận mật khẩu mới</label>
                            <div class="password-wrapper">
                                <input type="password" id="confirmPassword" name="confirmPassword" required>
                                <span class="toggle-password" data-target="confirmPassword">
                                    <i class="fas fa-eye"></i>
                                 </span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-register">Đổi mật khẩu</button>
                    </form>
                </div>
                <div class="profile-tab profile-support">
                    <h2>Phản hồi & Hỗ trợ</h2>

                    <!-- Form gửi yêu cầu -->
                    <form class="profile-form" th:action="@{/profile/support}" method="post" th:object="${supportRequest}">
                        <div class="form-group">
                            <label>Tiêu đề phản hồi</label>
                            <textarea th:field="*{title}" rows="2" placeholder="Nhập tiêu đề bạn cần hỗ trợ..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Nội dung phản hồi</label>
                            <textarea th:field="*{content}" rows="4" placeholder="Nhập nội dung bạn cần hỗ trợ..." required></textarea>
                        </div>
                        <button class="btn btn-register" type="submit">Gửi phản hồi</button>
                    </form>

                    <!-- Thông báo gửi thành công -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

                    <!-- Danh sách phản hồi -->
                    <div class="support-history" th:if="${supportList != null}">
                        <h3 style="margin-top:32px;">Xem phản hồi đã gửi</h3>
                        <ul class="support-list">
                            <li class="support-item" th:each="item, iterStat : ${supportList}">
                                <!-- Tiêu đề có thể click -->
                                <div class="support-question"
                                     th:onclick="'toggleReply(' + ${iterStat.index} + ')'"
                                     style="cursor: pointer; color: #0a58ca;">
                                    <i class="fas fa-comments"></i>
                                    <span th:text="${item.title}"></span>
                                </div>

                                <!-- Nội dung chi tiết (ẩn/hiện khi click) -->
                                <div class="support-detail" th:id="'reply-' + ${iterStat.index}" style="display:none; margin-left: 15px;">
                                    <p><strong>Nội dung yêu cầu:</strong></p>
                                    <p th:text="${item.content}"></p>

                                    <p><strong>Gửi lúc:</strong>
                                        <span th:text="${item.createdAt}"></span>
                                    </p>

                                    <div th:if="${item.status.name() == 'PENDING'}">
                                        <p><strong>Phản hồi:</strong> Chúng tôi đã tiếp nhận yêu cầu và sẽ liên hệ bạn trong 24h.</p>
                                    </div>

                                    <div th:if="${item.status.name() == 'RESOLVED'}">
                                        <p><strong>Phản hồi của Admin:</strong></p>
                                        <p th:text="${item.reply}"></p>
                                        <p><strong>Ngày trả lời:</strong>
                                            <span th:text="${item.repliedAt}"></span>
                                        </p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<div th:replace="~{/page/fragments/footer :: footer}"></div>


<script th:src="@{/page/js/profile.js}"></script>

<script>
// Debug script để kiểm tra tab switching
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    
    const menuItems = document.querySelectorAll('.profile-menu-item');
    const tabs = document.querySelectorAll('.profile-tab');
    
    console.log('Menu items found:', menuItems.length);
    console.log('Tabs found:', tabs.length);
    
    menuItems.forEach(item => {
        console.log('Menu item:', item.dataset.tab);
        item.addEventListener('click', function() {
            console.log('Clicked on tab:', this.dataset.tab);
            
            const tabName = this.dataset.tab;
            
            // Remove active từ tất cả
            menuItems.forEach(i => i.classList.remove('active'));
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Gán active mới
            this.classList.add('active');
            const targetTab = document.querySelector(`.profile-tab.profile-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('Activated tab:', targetTab.className);
            } else {
                console.log('Target tab not found for:', tabName);
            }
        });
    });
});
</script>

</body>
</html>
