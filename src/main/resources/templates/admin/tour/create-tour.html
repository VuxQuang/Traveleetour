<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${isReadOnly} ? 'Xem chi tiết tour - Travelee Admin' : 'Tạo tour mới - Travelee Admin'"></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/admin/css/dashboard-style.css}">
    <link rel="stylesheet" th:href="@{/admin/css/users-style.css}">
    <link rel="stylesheet" th:href="@{/admin/css/create-tour.css}">
</head>
<body data-readonly="[[${isReadOnly}]]">
    <div class="dashboard-container">
        <div th:replace="~{/admin/fragments/header :: header}"></div>

        <div th:replace="~{/admin/fragments/sidebar :: aside}"></div>

        <main class="main-content">
            <div class="create-tour-container">
                <div class="create-tour-header">
                    <h1>
                        <i class="fas"
                           th:classappend="${isReadOnly} ? 'fa-eye' : 'fa-plus-circle'"></i>
                        <span th:text="${isReadOnly} ? 'Xem chi tiết tour' : 'Tạo tour mới'"></span>
                    </h1>
                    <p th:text="${isReadOnly} ? 'Xem chi tiết thông tin tour du lịch' : 'Điền thông tin để tạo tour mới'"></p>
                </div>

                <form class="create-tour-form" id="createTourForm" 
                      th:action="${isReadOnly} ? '#' : '/admin/tour/create'" 
                      method="post" 
                      th:object="${tourCreateRequest}">
                    
                    <!-- Hidden field để lưu ID tour khi xem -->
                    <input type="hidden" name="tourId" th:value="${tour?.id ?: ''}" />
                    
                    <!-- Thông tin cơ bản -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="title">Tên tour <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <input type="text" id="title" name="title" placeholder="Nhập tên tour" required th:field="*{title}"
                                       th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                <div class="form-group">
                    <label>Danh mục <span class="required">*</span></label>
                    <div class="hashtag-container">
                        <div class="hashtag-input-wrapper">
                            <input type="text" 
                                   class="hashtag-input" 
                                   placeholder="Chọn danh mục..."
                                   th:disabled="${isReadOnly}"
                                   readonly>
                            <div class="hashtag-dropdown">
                                <th:block th:each="category : ${categories}">
                                    <div class="hashtag-option" 
                                         th:data-category-id="${category.id}"
                                         th:data-category-name="${category.name}">
                                        <span th:text="${category.name}"></span>
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                        <div class="hashtag-tags" id="selectedTags">
                            <!-- Selected tags will be displayed here -->
                        </div>
                        <!-- Hidden inputs for form submission -->
                        <div class="hidden-inputs">
                            <th:block th:each="category : ${categories}">
                                <input type="checkbox" 
                                       th:id="'category_' + ${category.id}"
                                       th:name="categoryIds" 
                                       th:value="${category.id}"
                                       th:field="*{categoryIds}"
                                       th:disabled="${isReadOnly}"
                                       style="display: none;">
                            </th:block>
                        </div>
                    </div>
                </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="departure">Điểm khởi hành <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-plane-departure"></i>
                                    <input type="text" id="departure" name="departure" placeholder="Ví dụ: Hà Nội" required th:field="*{departure}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="destination">Điểm đến <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <input type="text" id="destination" name="destination" placeholder="Ví dụ: Sapa" required th:field="*{destination}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="duration">Thời gian (ngày) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-clock"></i>
                                    <input type="number" id="duration" name="duration" placeholder="Ví dụ: 3" required min="1" th:field="*{duration}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="maxParticipants">Số lượng tối đa <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-users"></i>
                                    <input type="number" id="maxParticipants" name="maxParticipants" placeholder="Ví dụ: 20" required min="1" th:field="*{maxParticipants}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="description">Mô tả tour <span class="required">*</span></label>
                            <div class="input-icon">
                                <i class="fas fa-align-left"></i>
                                <textarea id="description" name="description" placeholder="Mô tả chi tiết về tour" rows="4" required th:field="*{description}"
                                          th:attr="readonly=${isReadOnly} ? 'readonly' : null"></textarea>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="highlights">Điểm nổi bật</label>
                            <div class="input-icon">
                                <i class="fas fa-star"></i>
                                <textarea id="highlights" name="highlights" placeholder="Các điểm nổi bật của tour" rows="3" th:field="*{highlights}"
                                          th:attr="readonly=${isReadOnly} ? 'readonly' : null"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Bao gồm và không bao gồm -->
                    <div class="form-section">
                        <h3><i class="fas fa-list-check"></i> Dịch vụ bao gồm</h3>
                        <div class="includes-excludes-container">
                            <div class="includes-section">
                                <h4><i class="fas fa-check-circle"></i> Bao gồm</h4>
                                <!-- Readonly view -->
                                <div th:if="${isReadOnly}">
                                    <div class="dynamic-inputs">
                                        <div class="input-group" th:each="inc, iStat : ${tourCreateRequest != null and tourCreateRequest.includes != null ? tourCreateRequest.includes : {}}">
                                            <div class="input-icon">
                                                <i class="fas fa-plus"></i>
                                                <input type="text" class="dynamic-input" th:value="${inc}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Editable view -->
                                <div class="dynamic-inputs" id="includesContainer" th:if="${!isReadOnly}">
                                    <!-- Input mới để thêm -->
                                    <div class="input-group">
                                        <div class="input-icon">
                                            <i class="fas fa-plus"></i>
                                            <input type="text" th:name="'includes[' + ${tourCreateRequest != null and tourCreateRequest.includes != null ? tourCreateRequest.includes.size() : 0} + ']'" placeholder="Nhập dịch vụ bao gồm" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn-add" onclick="addInput('includesContainer', 'includes')" th:if="${!isReadOnly}">
                                    <i class="fas fa-plus"></i> Thêm dịch vụ
                                </button>
                            </div>
                            
                            <div class="excludes-section">
                                <h4><i class="fas fa-times-circle"></i> Không bao gồm</h4>
                                <!-- Readonly view -->
                                <div th:if="${isReadOnly}">
                                    <div class="dynamic-inputs">
                                        <div class="input-group" th:each="exc, eStat : ${tourCreateRequest != null and tourCreateRequest.excludes != null ? tourCreateRequest.excludes : {}}">
                                            <div class="input-icon">
                                                <i class="fas fa-minus"></i>
                                                <input type="text" class="dynamic-input" th:value="${exc}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Editable view -->
                                <div class="dynamic-inputs" id="excludesContainer" th:if="${!isReadOnly}">
                                    <!-- Input mới để thêm -->
                                    <div class="input-group">
                                        <div class="input-icon">
                                            <i class="fas fa-minus"></i>
                                            <input type="text" th:name="'excludes[' + ${tourCreateRequest != null and tourCreateRequest.excludes != null ? tourCreateRequest.excludes.size() : 0} + ']'" placeholder="Nhập dịch vụ không bao gồm" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn-add" onclick="addInput('excludesContainer', 'excludes')" th:if="${!isReadOnly}">
                                    <i class="fas fa-plus"></i> Thêm dịch vụ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Giá cả -->
                    <div class="form-section">
                        <h3><i class="fas fa-dollar-sign"></i> Thông tin giá</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adultPrice">Giá người lớn (VNĐ) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-user"></i>
                                    <input type="number" id="adultPrice" name="adultPrice" placeholder="Ví dụ: 2000000" required min="0" th:field="*{adultPrice}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="childPrice">Giá trẻ em (VNĐ) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-child"></i>
                                    <input type="number" id="childPrice" name="childPrice" placeholder="Ví dụ: 1500000" required min="0" th:field="*{childPrice}"
                                           th:attr="readonly=${isReadOnly} ? 'readonly' : null">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trạng thái và đặc biệt -->
                    <div class="form-section">
                        <h3><i class="fas fa-cog"></i> Trạng thái và đặc biệt</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="status">Trạng thái <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-toggle-on"></i>
                                    <select id="status" name="status" required th:field="*{status}"
                                            th:attr="disabled=${isReadOnly} ? 'disabled' : null">
                                        <option value="">Chọn trạng thái</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Tạm ngưng</option>
                                        <option value="full">Đã đầy</option>
                                        <option value="canceled">Đã hủy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Đặc biệt</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="featured" name="featured" th:field="*{featured}"
                                               th:attr="disabled=${isReadOnly} ? 'disabled' : null">
                                        <span class="checkmark"></span>
                                        Tour nổi bật
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="isHot" name="isHot" th:field="*{isHot}"
                                               th:attr="disabled=${isReadOnly} ? 'disabled' : null">
                                        <span class="checkmark"></span>
                                        Tour hot
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="hasPromotion" name="hasPromotion" th:field="*{hasPromotion}"
                                               th:attr="disabled=${isReadOnly} ? 'disabled' : null">
                                        <span class="checkmark"></span>
                                        Có khuyến mãi
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hình ảnh -->
                    <div class="form-section">
                        <h3><i class="fas fa-images"></i> Hình ảnh tour</h3>
                        <div class="image-upload-area">
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Kéo thả hình ảnh vào đây hoặc <span class="upload-link">chọn file</span></p>
                                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;"
                                       th:attr="disabled=${isReadOnly} ? 'disabled' : null">
                            </div>
                                                         <div class="image-preview" id="imagePreview">
                                 <!-- Hiển thị ảnh cũ từ tour -->
                                 <th:block th:if="${tourCreateRequest != null and tourCreateRequest.imageUrls != null}">
                                     <div class="image-preview-item" th:each="img : ${tourCreateRequest.imageUrls}">
                                         <img th:src="${img}" alt="Ảnh tour">
                                         <input type="hidden" name="imageUrls" th:value="${img}">
                                         <button type="button" class="remove-image" onclick="removeExistingImage(this)" th:if="${!isReadOnly}" title="Xóa ảnh cũ">×</button>
                                         <div class="image-label" th:if="${!isReadOnly}">Ảnh cũ</div>
                                     </div>
                                 </th:block>
                                 
                                 <!-- Thông báo khi không có ảnh -->
                                 <div class="no-images-message" th:if="${(tourCreateRequest == null or tourCreateRequest.imageUrls == null or #lists.isEmpty(tourCreateRequest.imageUrls)) and isReadOnly}">
                                     <p style="color: #ff6b6b; text-align: center; padding: 20px;">⚠️ Tour này chưa có hình ảnh.</p>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <!-- Lịch trình -->
                    <div class="form-section">
                        <h3><i class="fas fa-route"></i> Lịch trình tour</h3>
                        <!-- Readonly view -->
                        <div th:if="${isReadOnly}">
                            <div class="itinerary-item" th:each="it, itStat : ${tourCreateRequest != null ? tourCreateRequest.itineraries : {}}">
                                <h4>
                                    <span th:text="${'Ngày ' + it.dayNumber}"></span>
                                </h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Tiêu đề ngày</label>
                                        <div class="input-icon">
                                            <i class="fas fa-heading"></i>
                                            <input type="text" th:value="${it.title}" readonly>
                                        </div>
                                    </div>
                                    <div class="form-group" th:if="${it.meals != null}">
                                        <label>Bữa ăn</label>
                                        <div class="input-icon">
                                            <i class="fas fa-utensils"></i>
                                            <input type="text" th:value="${it.meals}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width" th:if="${it.description != null and !#lists.isEmpty(it.description)}">
                                    <label>Mô tả hoạt động</label>
                                    <div class="dynamic-inputs">
                                        <div class="input-group" th:each="desc : ${it.description}">
                                            <div class="input-icon">
                                                <i class="fas fa-align-left"></i>
                                                <input type="text" th:value="${desc}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width" th:if="${it.activities != null and !#lists.isEmpty(it.activities)}">
                                    <label>Hoạt động cụ thể</label>
                                    <div class="dynamic-inputs">
                                        <div class="input-group" th:each="act : ${it.activities}">
                                            <div class="input-icon">
                                                <i class="fas fa-list"></i>
                                                <input type="text" th:value="${act}" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width" th:if="${it.accommodation != null}">
                                    <label>Nơi lưu trú</label>
                                    <div class="input-icon">
                                        <i class="fas fa-bed"></i>
                                        <input type="text" th:value="${it.accommodation}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Editable view -->
                        <div id="itineraryContainer" th:if="${!isReadOnly}">
                            <!-- Lịch trình sẽ được thêm động -->
                        </div>
                        <button type="button" class="btn-add-itinerary" onclick="addItinerary()" th:if="${!isReadOnly}">
                            <i class="fas fa-plus"></i> Thêm ngày
                        </button>
                    </div>

                    <!-- Lịch khởi hành -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar-alt"></i> Lịch khởi hành</h3>
                        <!-- Readonly view -->
                        <div th:if="${isReadOnly}">
                            <div class="schedule-item" th:each="sch : ${tourCreateRequest != null ? tourCreateRequest.schedules : {}}">
                                <h4>Lịch khởi hành</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ngày khởi hành</label>
                                        <div class="input-icon">
                                            <i class="fas fa-calendar"></i>
                                            <input type="text" th:value="${#temporals.format(sch.departureDate, 'dd/MM/yyyy')}" readonly>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Ngày về</label>
                                        <div class="input-icon">
                                            <i class="fas fa-calendar-check"></i>
                                            <input type="text" th:value="${#temporals.format(sch.returnDate, 'dd/MM/yyyy')}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" th:if="${sch.specialPrice != null}">
                                        <label>Giá đặc biệt (VNĐ)</label>
                                        <div class="input-icon">
                                            <i class="fas fa-dollar-sign"></i>
                                            <input type="text" th:value="${#numbers.formatDecimal(sch.specialPrice, 0, 'COMMA', 0, 'POINT')}" readonly>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Số chỗ còn lại</label>
                                        <div class="input-icon">
                                            <i class="fas fa-users"></i>
                                            <input type="text" th:value="${sch.availableSlots}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Trạng thái</label>
                                    <div class="input-icon">
                                        <i class="fas fa-toggle-on"></i>
                                        <input type="text" th:value="${sch.status}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Editable view -->
                        <div id="scheduleContainer" th:if="${!isReadOnly}">
                            <!-- Lịch khởi hành sẽ được thêm động -->
                        </div>
                        <button type="button" class="btn-add-schedule" onclick="addSchedule()" th:if="${!isReadOnly}">
                            <i class="fas fa-plus"></i> Thêm lịch khởi hành
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="window.history.back()">
                            <i class="fas fa-times"></i> Quay lại
                        </button>
                        <button type="submit" class="btn-submit" th:if="${!isReadOnly}">
                            <i class="fas fa-save"></i>
                            <span>Tạo tour</span>
                        </button>
                    </div>
                </form>

            </div>
        </main>
    </div>
    <script th:src="@{/admin/js/create-tour.js}"></script>
</body>
</html>