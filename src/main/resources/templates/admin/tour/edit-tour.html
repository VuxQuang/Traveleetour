<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sửa tour - Travelee Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/admin/css/dashboard-style.css}">
    <link rel="stylesheet" th:href="@{/admin/css/users-style.css}">
    <link rel="stylesheet" th:href="@{/admin/css/create-tour.css}">
</head>
<body>
    <div class="dashboard-container">
        <div th:replace="~{/admin/fragments/header :: header}"></div>

        <div th:replace="~{/admin/fragments/sidebar :: aside}"></div>

        <main class="main-content">
            <div class="create-tour-container">
                <div class="create-tour-header">
                    <h1><i class="fas fa-edit"></i> Sửa tour</h1>
                    <p>Cập nhật thông tin tour du lịch</p>
                </div>

                <form class="create-tour-form" id="editTourForm" th:action="@{'/admin/tour/edit/' + ${tour.id}}" method="post" th:object="${tourCreateRequest}">
                    <!-- Thông tin cơ bản -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="title">Tên tour <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <input type="text" id="title" name="title" placeholder="Nhập tên tour" required th:field="*{title}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Danh mục <span class="required">*</span></label>
                                <div class="hashtag-container">
                                    <div class="hashtag-input-wrapper">
                                        <input type="text" 
                                               class="hashtag-input" 
                                               placeholder="Chọn danh mục..."
                                               readonly>
                                        <div class="hashtag-dropdown">
                                            <th:block th:each="category : ${categories}">
                                                <div class="hashtag-option" 
                                                     th:data-category-id="${category.id}"
                                                     th:data-category-name="${category.name}">
                                                    <span th:text="${category.name}"></span>
                                                    <i class="fas fa-plus"></i>
                                                </div>
                                            </th:block>
                                        </div>
                                    </div>
                                    <div class="hashtag-tags" id="selectedTags">
                                        <!-- Selected tags will be displayed here -->
                                    </div>
                                    <!-- Hidden inputs for form submission -->
                                    <div class="hidden-inputs">
                                        <th:block th:each="category : ${categories}">
                                            <input type="checkbox" 
                                                   th:id="'category_' + ${category.id}"
                                                   th:name="categoryIds" 
                                                   th:value="${category.id}"
                                                   th:field="*{categoryIds}"
                                                   style="display: none;">
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="departure">Điểm khởi hành <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-plane-departure"></i>
                                    <input type="text" id="departure" name="departure" placeholder="Ví dụ: Hà Nội" required th:field="*{departure}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="destination">Điểm đến <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <input type="text" id="destination" name="destination" placeholder="Ví dụ: Sapa" required th:field="*{destination}">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="duration">Thời gian (ngày) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-clock"></i>
                                    <input type="number" id="duration" name="duration" placeholder="Ví dụ: 3" required min="1" th:field="*{duration}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="maxParticipants">Số lượng tối đa <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-users"></i>
                                    <input type="number" id="maxParticipants" name="maxParticipants" placeholder="Ví dụ: 20" required min="1" th:field="*{maxParticipants}">
                                </div>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="description">Mô tả tour <span class="required">*</span></label>
                            <div class="input-icon">
                                <i class="fas fa-align-left"></i>
                                <textarea id="description" name="description" placeholder="Mô tả chi tiết về tour" rows="4" required th:field="*{description}"></textarea>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="highlights">Điểm nổi bật</label>
                            <div class="input-icon">
                                <i class="fas fa-star"></i>
                                <textarea id="highlights" name="highlights" placeholder="Các điểm nổi bật của tour" rows="3" th:field="*{highlights}"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Bao gồm và không bao gồm -->
                    <div class="form-section">
                        <h3><i class="fas fa-list-check"></i> Dịch vụ bao gồm</h3>
                        <div class="includes-excludes-container">
                            <div class="includes-section">
                                <h4><i class="fas fa-check-circle"></i> Bao gồm</h4>
                                <div class="dynamic-inputs" id="includesContainer">
                                    <!-- Input mới để thêm -->
                                    <div class="input-group">
                                        <div class="input-icon">
                                            <i class="fas fa-plus"></i>
                                            <input type="text" th:name="'includes[' + ${tourCreateRequest != null and tourCreateRequest.includes != null ? tourCreateRequest.includes.size() : 0} + ']'" placeholder="Nhập dịch vụ bao gồm" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <!-- Các input hiện có -->
                                    <div class="input-group" th:each="include, iterStat : ${tourCreateRequest.includes}" th:if="${include != null and include != ''}">
                                        <div class="input-icon">
                                            <i class="fas fa-plus"></i>
                                            <input type="text" th:name="'includes[' + ${iterStat.index} + ']'" th:value="${include}" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn-add" onclick="addInput('includesContainer', 'includes')">
                                    <i class="fas fa-plus"></i> Thêm dịch vụ
                                </button>
                            </div>
                            
                            <div class="excludes-section">
                                <h4><i class="fas fa-times-circle"></i> Không bao gồm</h4>
                                <div class="dynamic-inputs" id="excludesContainer">
                                    <!-- Input mới để thêm -->
                                    <div class="input-group">
                                        <div class="input-icon">
                                            <i class="fas fa-minus"></i>
                                            <input type="text" th:name="'excludes[' + ${tourCreateRequest != null and tourCreateRequest.excludes != null ? tourCreateRequest.excludes.size() : 0} + ']'" placeholder="Nhập dịch vụ không bao gồm" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <!-- Các input hiện có -->
                                    <div class="input-group" th:each="exclude, iterStat : ${tourCreateRequest.excludes}" th:if="${exclude != null and exclude != ''}">
                                        <div class="input-icon">
                                            <i class="fas fa-minus"></i>
                                            <input type="text" th:name="'excludes[' + ${iterStat.index} + ']'" th:value="${exclude}" class="dynamic-input">
                                        </div>
                                        <button type="button" class="btn-remove" onclick="removeInput(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn-add" onclick="addInput('excludesContainer', 'excludes')">
                                    <i class="fas fa-plus"></i> Thêm dịch vụ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Giá cả -->
                    <div class="form-section">
                        <h3><i class="fas fa-dollar-sign"></i> Thông tin giá</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="adultPrice">Giá người lớn (VNĐ) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-user"></i>
                                    <input type="number" id="adultPrice" name="adultPrice" placeholder="Ví dụ: 2000000" required min="0" th:field="*{adultPrice}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="childPrice">Giá trẻ em (VNĐ) <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-child"></i>
                                    <input type="number" id="childPrice" name="childPrice" placeholder="Ví dụ: 1500000" required min="0" th:field="*{childPrice}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trạng thái và đặc biệt -->
                    <div class="form-section">
                        <h3><i class="fas fa-cog"></i> Trạng thái và đặc biệt</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="status">Trạng thái <span class="required">*</span></label>
                                <div class="input-icon">
                                    <i class="fas fa-toggle-on"></i>
                                    <select id="status" name="status" required th:field="*{status}">
                                        <option value="">Chọn trạng thái</option>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Tạm ngưng</option>
                                        <option value="full">Đã đầy</option>
                                        <option value="canceled">Đã hủy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Đặc biệt</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="featured" name="featured" th:field="*{featured}">
                                        <span class="checkmark"></span>
                                        Tour nổi bật
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="isHot" name="isHot" th:field="*{isHot}">
                                        <span class="checkmark"></span>
                                        Tour hot
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="hasPromotion" name="hasPromotion" th:field="*{hasPromotion}">
                                        <span class="checkmark"></span>
                                        Có khuyến mãi
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hình ảnh -->
                    <div class="form-section">
                        <h3><i class="fas fa-images"></i> Hình ảnh tour</h3>
                        <div class="image-upload-area">
                            <div class="upload-zone" id="uploadZone">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Kéo thả hình ảnh vào đây hoặc <span class="upload-link">chọn file</span></p>
                                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="image-preview" id="imagePreview">
                                <!-- Hiển thị ảnh cũ từ tour -->
                                <th:block th:if="${tourCreateRequest != null and tourCreateRequest.imageUrls != null}">
                                    <div class="image-preview-item" th:each="img : ${tourCreateRequest.imageUrls}">
                                        <img th:src="${img}" alt="Ảnh tour">
                                        <input type="hidden" name="imageUrls" th:value="${img}">
                                        <button type="button" class="remove-image" onclick="removeExistingImage(this)" title="Xóa ảnh cũ">×</button>
                                        <div class="image-label">Ảnh cũ</div>
                                    </div>
                                </th:block>
                                
                                <!-- Thông báo khi không có ảnh -->
                                <div class="no-images-message" th:if="${(tourCreateRequest == null or tourCreateRequest.imageUrls == null or #lists.isEmpty(tourCreateRequest.imageUrls))}">
                                    <p style="color: #ff6b6b; text-align: center; padding: 20px;">⚠️ Tour này chưa có hình ảnh.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lịch trình -->
                    <div class="form-section">
                        <h3><i class="fas fa-route"></i> Lịch trình tour</h3>
                        <div id="itineraryContainer">
                            <!-- Lịch trình sẽ được thêm động -->
                            <div class="itinerary-item" th:each="itinerary, iterStat : ${tourCreateRequest.itineraries}" th:if="${itinerary != null}">
                                <h4>
                                    <span th:text="${'Ngày ' + itinerary.dayNumber}"></span>
                                </h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Tiêu đề ngày</label>
                                        <div class="input-icon">
                                            <i class="fas fa-heading"></i>
                                            <input type="text" th:name="'itineraries[' + ${iterStat.index} + '].title'" th:value="${itinerary.title}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Số ngày</label>
                                        <div class="input-icon">
                                            <i class="fas fa-calendar-day"></i>
                                            <input type="number" th:name="'itineraries[' + ${iterStat.index} + '].dayNumber'" th:value="${itinerary.dayNumber}" required min="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label>Mô tả hoạt động</label>
                                    <div class="input-icon">
                                        <i class="fas fa-align-left"></i>
                                        <textarea th:name="'itineraries[' + ${iterStat.index} + '].description'" rows="3" th:text="${itinerary.description}"></textarea>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <label>Hoạt động cụ thể</label>
                                    <div class="input-icon">
                                        <i class="fas fa-list"></i>
                                        <textarea th:name="'itineraries[' + ${iterStat.index} + '].activities'" rows="2" th:text="${itinerary.activities}"></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Bữa ăn</label>
                                        <div class="input-icon">
                                            <i class="fas fa-utensils"></i>
                                            <input type="text" th:name="'itineraries[' + ${iterStat.index} + '].meals'" th:value="${itinerary.meals}">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Nơi lưu trú</label>
                                        <div class="input-icon">
                                            <i class="fas fa-bed"></i>
                                            <input type="text" th:name="'itineraries[' + ${iterStat.index} + '].accommodation'" th:value="${itinerary.accommodation}">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn-remove-itinerary" onclick="removeItinerary(this)">
                                    <i class="fas fa-trash"></i> Xóa ngày
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn-add-itinerary" onclick="addItinerary()">
                            <i class="fas fa-plus"></i> Thêm ngày
                        </button>
                    </div>

                    <!-- Lịch khởi hành -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar-alt"></i> Lịch khởi hành</h3>
                        <div id="scheduleContainer">
                            <!-- Lịch khởi hành sẽ được thêm động -->
                            <div class="schedule-item" th:each="schedule, iterStat : ${tourCreateRequest.schedules}" th:if="${schedule != null}">
                                <h4>Lịch khởi hành</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ngày khởi hành</label>
                                        <div class="input-icon">
                                            <i class="fas fa-calendar"></i>
                                            <input type="date" th:name="'schedules[' + ${iterStat.index} + '].departureDate'" th:value="${schedule.departureDate}" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Ngày về</label>
                                        <div class="input-icon">
                                            <i class="fas fa-calendar-check"></i>
                                            <input type="date" th:name="'schedules[' + ${iterStat.index} + '].returnDate'" th:value="${schedule.returnDate}" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Giá đặc biệt</label>
                                        <div class="input-icon">
                                            <i class="fas fa-dollar-sign"></i>
                                            <input type="number" th:name="'schedules[' + ${iterStat.index} + '].specialPrice'" th:value="${schedule.specialPrice}" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Số chỗ còn trống</label>
                                        <div class="input-icon">
                                            <i class="fas fa-users"></i>
                                            <input type="number" th:name="'schedules[' + ${iterStat.index} + '].availableSlots'" th:value="${schedule.availableSlots}" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Trạng thái</label>
                                    <div class="input-icon">
                                        <i class="fas fa-toggle-on"></i>
                                        <select th:name="'schedules[' + ${iterStat.index} + '].status'" th:value="${schedule.status}">
                                            <option value="available">Còn chỗ</option>
                                            <option value="full">Đã đầy</option>
                                            <option value="closed">Đã đóng</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" class="btn-remove-schedule" onclick="removeSchedule(this)">
                                    <i class="fas fa-trash"></i> Xóa lịch
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn-add-schedule" onclick="addSchedule()">
                            <i class="fas fa-plus"></i> Thêm lịch khởi hành
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="window.history.back()">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-save"></i> Cập nhật tour
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <script th:src="@{/admin/js/create-tour.js}"></script>
</body>
</html>